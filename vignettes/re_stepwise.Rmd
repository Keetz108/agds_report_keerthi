---
title: "Report Exercise 4"
author: keerthi
date: "2025-04-28"
output: html_document

---

```{r package_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# installing packages in case not installed
use_pkgs <- c("dplyr", "rmarkdown", "tidyverse","knitr", "tidyr", "ggplot2", "writexl", "car")  
new_pkgs <- use_pkgs[!(use_pkgs %in% installed.packages()[, "Package"])]
if (length(new_pkgs) > 0) install.packages(new_pkgs,repos = "http://cran.us.r-project.org")
invisible(lapply(use_pkgs, require, character.only = TRUE))

# loading required libraries
library(dplyr)
library(rmarkdown)
library(tidyverse)
library(knitr)
library(here)
library(tidyr)
library(ggplot2)
library(car)
library(writexl)
```


```{r r_analysis1, echo=FALSE, message=FALSE, warning=FALSE}

# introduction: in this exercise, a stepwise forward regression is to be performed for the task of modelling GPP as a function of predictors available in the dataset of half-hourly ecosystem fluxes. with loops in the main chunks, graphs are provided in separate graph chunk for their smooth running.


# 1_bivariate model

data <- read.csv(here::here("data", "RE4_df_for_stepwise_regression.csv"))

colSums(!is.na(data))

sum(!is.na(data))

dim(na.omit(data[,-c(1,2,12)]))

var_data <- data[,-c(1,2,12)]


#rearranging
var_data_new <- var_data[,c(13,1:12,14)]


#Set response variable
resp_var <- "GPP_NT_VUT_REF"

#List of all predictors
predictors <- setdiff(names(var_data_new), resp_var)

#Create empty lists to store results
aic_list <- c()
model_list <- list()

#Looping through each predictor
for (pred in predictors) {
  formula_str <- paste(resp_var, "~", pred)
  model <- lm(as.formula(formula_str), data = var_data_new)
  model_list[[pred]] <- model
  aic_list[pred] <- AIC(model)
}

best_predictor <- names(which.min(aic_list))
best_aic <- min(aic_list)

cat("Best predictor:", best_predictor, "| AIC:", best_aic, "\n")

aic_df <- data.frame(Predictor = names(aic_list), AIC = unname(aic_list))

# tables from knitr function
kable(aic_df, caption = "AIC values for single-predictor linear models")

knitr::opts_chunk$set(echo = TRUE)
```


```{r, r_analysis2, echo=FALSE, message=FALSE, warning=FALSE}

# 2_stepwise forward regression,

# Load data
#Set response variable
response <- "GPP_NT_VUT_REF"

#List of all predictors
predictors <- setdiff(names(var_data_new), response)

r2_results <- data.frame(predictor = predictors, R2 = NA)

for (i in seq_along(predictors)) {
  formula <- as.formula(paste(response, "~", predictors[i]))
  model <- lm(formula, data = data)
  r2_results$R2[i] <- summary(model)$r.squared
}

r2_results <- r2_results[order(-r2_results$R2), ]

print(r2_results)


# checking multicollinearity

# top 5 predictors based on R2
top_predictors <- head(r2_results$predictor, 6)

# formula for multivariate model
multi_formula <- as.formula(paste(response, "~", paste(top_predictors, collapse = "+")))

# fit multivariate model
multi_model <- lm(multi_formula, data = data)

# calculate VIF to check multicollinearity
vif_values <- vif(multi_model)

print(vif_values)

# tables from knitr function
kable(r2_results, caption = "R² Results Table")
kable(vif_values, caption = "vif values for multicollinearity")

knitr::opts_chunk$set(echo = TRUE)
```


```{r plots, echo=FALSE}

# generating plots and saving them

# plot_bivariate model

aic_plot <- ggplot(aic_df, aes(x = reorder(Predictor, AIC), y = AIC)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() +
  labs(title = "AIC of Bivariate Models (Single Predictor)", 
       x = "Predictor", y = "AIC") +
  theme_minimal()

print(aic_plot)

ggsave("../figures/re_stepwise_bivariate_plot1.jpg", plot = aic_plot, width = 8, height = 6, dpi = 300)


# plot_R squared model

R_squared <- ggplot(r2_results, aes(x = reorder(predictor, R2), y = R2)) +
  geom_col(fill = "skyblue") +
  coord_flip() +
  labs(title = "R² for Each Bivariate Model", x = "Predictor", y = "R²")

print(R_squared)

ggsave("../figures/re_stepwise_forward_regression_plot2.jpg", plot = R_squared, width = 8, height = 6, dpi = 300)

```

# introduction: in this exercise, a stepwise forward regression is to be performed for the task of modelling GPP as a function of predictors available in the dataset of half-hourly ecosystem fluxes. with loops in the main chunks, graphs are provided in separate graph chunk for their smooth running. The discussion of the results generated by the codes follows: 

# bivariate models

# Bivariate models are used when two count dependent variables are correlated and they need to be jointly estimated. The evaluation of all bivariate linear models using AIC reveals considerable variation in model performance depending on the predictor used. Among the tested variables, best_predictor PPFD_IN emerged as the most informative predictor of GPP_NT_VUT_REF, as indicated by the lowest AIC value (AIC: 77577.87, best_aic). Lower AIC values suggest a better trade-off between model fit and complexity. Since all models evaluated here are simple (single-predictor), differences in AIC primarily reflect differences in explanatory power rather than overfitting. The bar plot clearly highlights a predictor PPFD_IN with notably better performance, while others show relatively poor fits. These results provide a useful first step for narrowing down predictors for a multivariate model. However, further analysis is needed to assess interactions and potential multicollinearity among predictors before final model selection.


# stepwise forward regession

# The stepwise forward regression procedure was implemented to identify the combination of predictors that best explain the variability in the response variable GPP_NT_VUT_REF. Starting with no predictors, variables were added one at a time based on their contribution to improving model fit, as measured by increases in R².

# The table of R² results shows the incremental explanatory power of each predictor when included in the model. Predictors with higher R² (coefficient of determination) values indicate stronger relationships with the response variable. The table shows that PPFD_IN has the highest value of 0.45, that means, it explains 45.20% variance of the variance in response variable. This means more than 50% are likely to be explained by other response varibles.While the stepwise method is useful for exploratory model selection, it has limitations including the risk of overfitting and potential bias due to correlated predictors. Further validation was done using multicollinearity to explore the correlatedness between predictors. Such cross-validation showed that all the predictor variables including PPFD_IN are highly correlated with each other (VIF > 5). Predictor VPD_F has the lowest at 3.5 (less than 5) which shows moderate collinearity with the rest of the predictors. With this, since the variability of the explanatory PPFD_IN, can be mostly explained by all the other predictors (high), it could be inferred that this variable is redundant in our final model.
